# 制品

## 制品的分类

可以从三个维度对制品进行分类：

**应用制品和项目制品**

应用制品包含了部署一个应用所需的所有内容，包括镜像、依赖的addon、以及各种配置信息。

项目制品是由一个或多个应用制品按照一定部署顺序组成的制品。部署一个项目制品时，Erda 会按照用户定义的部署顺序，分批部署该制品中引用的应用制品。

**临时制品和非临时制品**

在使用流水线创建应用制品时，若制品版本或代码分支符合以下条件之一，则创建的制品为非临时制品：

- 在 Release Action 中填写了 `tag_version`；

- 代码分支符合下面的格式（即以`release/`为前缀，后缀部分符合[语义化版本 2.0.0](https://semver.org/lang/zh-CN/) ）

```text
release/{[v]主版本号}.{次版本号}[.修订版本号][-先行版本号][+版本无关的构建信息]
```

否则，创建的制品为临时制品。

Erda 每天会进行垃圾回收，将创建时间在一个月以前且当前未被引用的临时制品及其镜像回收，而非临时制品不会被回收。

创建项目制品时，只能引用非临时制品，不能引用临时制品。项目制品一定为非临时制品。

在 **DevOps 平台 > 某项目 > 应用中心 > 制品** 的制品管理页面上，可以看到本项目下所有非临时制品并对它们进行管理。

![制品管理页面](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/e0112765-b1ab-40c0-ae2c-50bb10caf4fb.png)

临时制品只能在创建该制品的流水线上，通过 Release Action 的超链接查看。

![通过超链接查看临时制品](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/96bc7a77-17f8-4123-8138-68429d68359f.png)

**正式制品和非正式制品**

所有制品创建后都为非正式制品，可以在制品管理页面中将指定的制品转为正式版。转正后的制品为正式制品。

正式制品表示该制品为正式版本，不能对其进行修改（包括编辑、删除、转正）。

## 创建制品
创建制品前请先完成项目的集群设置和分支规则配置。

* 进入 **DevOps 平台 > 项目 > 项目设置 > 通用设置 > 集群设置** 设置集群。

* 进入 **DevOps 平台 > 项目 > 项目设置 > 代码设置 > 分支规则** 创建分支规则。

### 创建应用制品

目前制品仅支持通过 Release Action 创建应用制品。

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/01/19/7d563d17-0351-4fd9-a7e0-61c84eda67ed.png)

1. 进入 **我的应用 > 代码仓库 > 代码浏览**，创建流水线文件，添加 Action（任务类型 > 应用打包发布制品）并填写配置参数。

2. 进入 **我的应用 > 流水线**，选择分支和流水线，点击 **新建流水线**，完成构建后执行流水线。

3. 流水线执行成功即代表制品创建成功。

流水线将根据所在分支匹配分支规则，确认制品部署环境。

### 创建项目制品

可以通过选择应用制品和上传两种方式创建项目制品。

在 **DevOps平台 > 某项目 > 应用中心 > 制品 > 项目制品** 页面上，点击右上角的新建制品按钮，会弹出下拉列表，其中就包含两种创建项目制品的方式。

![创建项目制品的两种方式](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/d073662a-2e4f-4426-aaa0-0989bad8466f.png)

第一种方式，"**选择应用创建**"。

![选择应用创建制品](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/6f1ed1ef-1ec9-4527-829b-bb7ad12e95fc.png)

输入版本。版本是项目制品在项目维度下的唯一标识，不能与项目维度下的其他项目制品版本重复，且必须由英文、数字、下划线（ _ ）、中划线（ - ）和/或点（ . ）组成。

选择应用制品。这一步的前提是在本项目的应用下创建过应用制品。用户可以对应用制品进行分组，同一组中的应用制品在部署时没有先后顺序，不同组中的应用制品会按照组号从小到大的顺序进行部署，例如应用制品 A 需要依赖应用制品 B，可以把应用制品 B 放在第一组，制品 A 放在第二组，部署时制品 B 就会优先于制品 A 部署。此外，同一个应用下的制品只能被选择一次。

填写内容。内容即对该项目制品的描述，可以是changelog，也可以是备注信息，支持 markdown 语法。

点击提交，即可创建项目制品。用户可以在项目制品页面上看到刚创建的项目制品。

第二种方式，"**选择文件创建**"。

使用这种方式的前提是本地有在 Erda 平台上下载的项目制品包（zip格式）。一种场景是将一个项目制品从一个项目导入到另一个项目，在项目制品页面上，点击某个项目制品后面的操作按钮，点击下载，即可将该项目制品的 zip 包下载到本地。

点击上传 zip 文件，选择本地的制品包。

![上传制品](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/4e643be5-d490-4cd2-849c-c0ced3a93773.png)

Erda 会自动解析制品包中项目制品的版本信息和依赖的应用制品信息。

注意：

- 本项目中必须存在所有上传的项目制品引用的应用制品对应的应用，否则上传失败。

- 若上传的项目制品所引用的应用制品在本项目中不存在，则会用制品包中的内容创建一个应用制品。若相同 version 的应用制品已经存在，则不会创建新的应用制品，而是直接引用该引用制品。如果上传的制品包中的应用制品的 dice.yml 文件与已存在的同名应用制品的 dice.yml 不同，该包中的 dice.yml 将会被忽略。

## 制品的操作

在应用制品或项目制品列表的操作列中，点击三个小点，可以看到制品的操作有：删除、下载、编辑、转正、查看引用制品。其中，删除和转正操作也可以在应用制品或项目制品的非正式页面通过勾选制品后在下面的批量操作栏进行。

![制品的操作](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/537761b0-ffce-415d-b5ca-8fdfbf60f2d6.png)

![批量操作](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2022/02/28/98af2305-de3f-44fa-9883-a4a2b43055dd.png)

### 删除制品

一个应用制品必须同时满足下面三个条件才能被删除：

- 当前没有用该应用制品部署的 runtime；

- 没有任何项目制品引用该应用制品；

- 该应用制品不是正式版。

删除应用制品后，该应用制品的镜像也将被从镜像仓库中删除。

对于项目制品，只要其不是正式制品就可以被删除。

### 下载制品

只有项目制品才能被下载。下载一个制品后会得到一个 zip 格式的文件，其中包含了项目制品以及该项目制品引用的应用制品的信息。用户可以用该制品包在任意环境的 Erda 平台中上传制品（详情见上面的创建项目制品小节）。

### 编辑制品

编辑制品操作只能对非临时非正式制品进行。

编辑应用制品时，可以修改制品的版本和内容。

编辑项目制品时，可以修改项目制品的版本、应用制品和内容。

### 转正制品

转正操作只能对非临时非正式制品进行。

应用制品或项目制品转正后不能进行任何修改操作，包括编辑、删除和转正。

项目制品转正时，会自动将其引用的非正式应用制品全部转正。

### 查看引用制品

查看引用制品操作只能对项目制品进行。

点击查看引用制品后，页面会跳转到应用制品页面，并显示该项目制品引用的所有应用制品。
